package com.pony.adapter.client;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.net.Socket;

import com.pony.adapter.handler.ClientReciveHandler;
import com.pony.adapter.handler.IReciveMsgHandler;
import com.pony.adapter.queue.MsgQueue;

public class BaseClient implements Runnable {

	private String[] hostIps = null;
	int currHostIDx = 0;
	Socket socket = null;
	BufferedInputStream input = null;
    BufferedOutputStream output = null;
    IReciveMsgHandler reciveMsgHandler = null;
    String tempMsg = "";
	public BaseClient(String[] hostIps, ClientReciveHandler reciveMsgHandler){
		this.hostIps = hostIps;
		
		this.reciveMsgHandler = reciveMsgHandler;
		((ClientReciveHandler)this.reciveMsgHandler).setClient(this);
	}
	
	@Override
	public void run() {
		while(true){
			try {
				connectToServer();
				startRecive();
				
			} catch (Exception e) {
				e.printStackTrace();
				
				try {
					if(input != null)
						input.close();
				} catch (Exception e2) {
					// TODO: handle exception
				}
				
				try {
					if(output != null)
						output.close();
				} catch (Exception e2) {
					// TODO: handle exception
				}
				
				try {
					if(socket != null)
						socket.close();
				} catch (Exception e2) {
					// TODO: handle exception
				}
				
			}
			
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				
			}
		}
	}
	
	private void startRecive() throws Exception{
		while(true){
//			input.read();
			if(!tempMsg.equals("")){
				this.reciveMsgHandler.reciveMsg(tempMsg);
				checkResponse();
				
			}
			
			while(MsgQueue.msgQueueLength() > 0){
				tempMsg = MsgQueue.takeMsg() + "</EOF>";
				this.reciveMsgHandler.reciveMsg(tempMsg);
				checkResponse();
				
			}
		}
	}
	
	private void checkResponse() throws Exception{
		byte[] buff = new byte[1024];
        String data = "";
        int length;
        while ((length = input.read(buff)) > 0){
    		data += new String(buff, 0, length);
    		System.out.println("recive data : " + data);
    		if(data.equals("</EOF>")){
    			tempMsg = "";
    			return;
    		}
    	}
	}
	
	private void connectToServer() throws Exception{
		String[] tokens = null;
		int port;
		String host;
		try {
			System.out.println("Try to connect : " + hostIps[currHostIDx]);
			tokens = hostIps[currHostIDx].split(":");
			currHostIDx = currHostIDx == 0 ? 1 : 0;
			
			host = tokens[0];
			port = Integer.parseInt(tokens[1]);
			
			socket = new Socket(host,port);
			socket.setSoTimeout(10000);
			input = new BufferedInputStream(socket.getInputStream());
			output = new BufferedOutputStream(socket.getOutputStream());
			System.out.println("Connected.");
			
			
		} catch (Exception e) {
			System.out.println("Connect Fail.");
			//e.printStackTrace();
			
			throw e;
		}
	}
	
	public void sendToServer(String msg) throws IOException{
		
		output.write(msg.getBytes());
		output.flush();
	}

}
